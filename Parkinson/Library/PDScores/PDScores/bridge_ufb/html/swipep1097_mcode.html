<pre class="code">
<span class="srcline"><span class="lineno"><a href="160,1" id="srcline1">  1</a></span><span class="line"> <span class="keyword">function</span> [<span class="var type1" id="S2T3U3">p</span>,<span class="var type1" id="S3T3U4">t</span>,<span class="var type1" id="S4T3U5">s</span>] = swipep(<span class="var type1" id="S5T3U8">x</span>,<span class="var type1" id="S6T1U9">fs</span>,<span class="mxinfo " id="T8:U6"><span class="var type2" id="S7T8V3U10">plim</span></span>,<span class="mxinfo " id="T1:U8"><span class="var type2" id="S8T1V4U11">dt</span></span>,<span class="mxinfo " id="T1:U10"><span class="var type2" id="S9T1V5U12">dlog2p</span></span>,<span class="mxinfo " id="T1:U12"><span class="var type2" id="S10T1V5U13">dERBs</span></span>,<span class="mxinfo " id="T1:U14"><span class="var type2" id="S11T1V5U14">woverlap</span></span>,<span class="mxinfo " id="T1:U16"><span class="var type2" id="S12T1V5U15">sTHR</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,2" id="srcline2">  2</a></span><span class="line"> coder.extrinsic(<span class="string">'exist'</span>,<span class="string">'warning'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="160,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% SWIPEP Pitch estimation using SWIPE'.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%    P = SWIPEP(X,Fs,[PMIN PMAX],DT,DLOG2P,DERBS,STHR) estimates the pitch </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%    of the vector signal X every DT seconds. The sampling frequency of</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%    the signal is Fs (in Hertz). The spectrum is computed using a Hann</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%    window with an overlap WOVERLAP between 0 and 1. The spectrum is</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,8" id="srcline8">  8</a></span><span class="line"><span class="comment">%    sampled uniformly in the ERB scale with a step size of DERBS ERBs. The</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,9" id="srcline9">  9</a></span><span class="line"><span class="comment">%    pitch is searched within the range [PMIN PMAX] (in Hertz) with samples</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">%    distributed every DLOG2P units on a base-2 logarithmic scale of Hertz. </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%    The pitch is fine-tuned using parabolic interpolation with a resolution</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%    of 1 cent. Pitch estimates with a strength lower than STHR are treated</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">%    as undefined.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%    </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">%    [P,T,S] = SWIPEP(X,Fs,[PMIN PMAX],DT,DLOG2P,DERBS,WOVERLAP,STHR) </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">%    returns the times T at which the pitch was estimated and the pitch </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">%    strength S of every pitch estimate.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%    P = SWIPEP(X,Fs) estimates the pitch using the default settings PMIN =</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">%    30 Hz, PMAX = 5000 Hz, DT = 0.001 s, DLOG2P = 1/48 (48 steps per </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%    octave), DERBS = 0.1 ERBs, WOVERLAP = 0.5, and STHR = -Inf.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%    P = SWIPEP(X,Fs,<span class="keyword">...</span><span class="comment">,[],...) uses the default setting for the parameter</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%    replaced with the placeholder [].</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">%    REMARKS: (1) For better results, make DLOG2P and DERBS as small as </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%    possible and WOVERLAP as large as possible. However, take into account</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%    that the computational complexity of the algorithm is inversely </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,29" id="srcline29"> 29</a></span><span class="line"><span class="comment">%    proportional to DLOG2P, DERBS and 1-WOVERLAP, and that the  default </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">%    values have been found empirically to produce good results. Consider </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,31" id="srcline31"> 31</a></span><span class="line"><span class="comment">%    also that the computational complexity is directly proportional to the</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">%    number of octaves in the pitch search range, and therefore , it is </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">%    recommendable to restrict the search range to the expected range of</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%    pitch, if any. (2) This code implements SWIPE', which uses only the</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%    first and prime harmonics of the signal. To convert it into SWIPE,</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,36" id="srcline36"> 36</a></span><span class="line"><span class="comment">%    which uses all the harmonics of the signal, replace the word</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%    PRIMES with a colon (it is located almost at the end of the code).</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%    However, this may not be recommendable since SWIPE' is reported to </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">%    produce on average better results than SWIPE (Camacho and Harris,</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">%    2008).</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,41" id="srcline41"> 41</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">%    EXAMPLE: Estimate the pitch of the signal X every 10 ms within the</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,43" id="srcline43"> 43</a></span><span class="line"><span class="comment">%    range 75-500 Hz using the default resolution (i.e., 48 steps per</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">%    octave), sampling the spectrum every 1/20th of ERB, using a window </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">%    overlap factor of 50%, and discarding samples with pitch strength </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">%    lower than 0.2. Plot the pitch trace.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%       [x,Fs] = wavread(filename);</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">%       [p,t,s] = swipep(x,Fs,[75 500],0.01,[],1/20,0.5,0.2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">%       plot(1000*t,p)</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,50" id="srcline50"> 50</a></span><span class="line"><span class="comment">%       xlabel('Time (ms)')</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%       ylabel('Pitch (Hz)')</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,52" id="srcline52"> 52</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,53" id="srcline53"> 53</a></span><span class="line"><span class="comment">%    REFERENCES: Camacho, A., Harris, J.G, (2008) "A sawtooth waveform </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">%    inspired pitch estimator for speech and music," J. Acoust. Soc. Am.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">%    124, 1638-1652.</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,57" id="srcline57"> 57</a></span><span class="line"><span class="comment">%    MAINTENANCE HISTORY:</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%    - Added line 153 to avoid division by zero in line 154 if loudness</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">%      equals zero (06/23/2010).</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,60" id="srcline60"> 60</a></span><span class="line"><span class="keyword">if</span> coder.target(<span class="string">'MATLAB'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,61" id="srcline61"> 61</a></span><span class="line">    <span class="keyword">if</span> ~ exist( <span class="string">'plim'</span>, <span class="string">'var'</span> ) || isempty(<span class="var type0" id="S7T0U40">plim</span>), <span class="var type0" id="S7T0U43">plim</span> = [30 5000]; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,62" id="srcline62"> 62</a></span><span class="line">    <span class="keyword">if</span> ~ exist( <span class="string">'dt'</span>, <span class="string">'var'</span> ) || isempty(<span class="var type0" id="S8T0U59">dt</span>) || isnan(<span class="var type0" id="S8T0U62">dt</span>), <span class="var type0" id="S8T0U65">dt</span> = 0.001; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">if</span> ~ exist( <span class="string">'dlog2p'</span>, <span class="string">'var'</span> ) || isempty(<span class="var type0" id="S9T0U78">dlog2p</span>) || isnan(<span class="var type0" id="S9T0U81">dlog2p</span>), <span class="var type0" id="S9T0U84">dlog2p</span> = 1/48; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,64" id="srcline64"> 64</a></span><span class="line">    <span class="keyword">if</span> ~ exist( <span class="string">'dERBs'</span>, <span class="string">'var'</span> ) || isempty(<span class="var type0" id="S10T0U99">dERBs</span>) || isnan(<span class="var type0" id="S10T0U102">dERBs</span>), <span class="var type0" id="S10T0U105">dERBs</span> = 0.1; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,65" id="srcline65"> 65</a></span><span class="line">    <span class="keyword">if</span> ~ exist( <span class="string">'woverlap'</span>, <span class="string">'var'</span> ) || isempty(<span class="var type0" id="S11T0U118">woverlap</span>) || isnan(<span class="var type0" id="S11T0U121">woverlap</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,66" id="srcline66"> 66</a></span><span class="line">        <span class="var type0" id="S11T0U124">woverlap</span> = 0.5;</span></span>
<span class="srcline"><span class="lineno"><a href="160,67" id="srcline67"> 67</a></span><span class="line">    <span class="keyword">elseif</span> <span class="var type0" id="S11T0U129">woverlap</span>&gt;1 || <span class="var type0" id="S11T0U132">woverlap</span>&lt;0</span></span>
<span class="srcline"><span class="lineno"><a href="160,68" id="srcline68"> 68</a></span><span class="line">        error(<span class="string">'Window overlap must be between 0 and 1.'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,69" id="srcline69"> 69</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">if</span> ~ exist( <span class="string">'sTHR'</span>, <span class="string">'var'</span> ) || isempty(<span class="var type0" id="S12T0U149">sTHR</span>) || isnan(<span class="var type0" id="S12T0U152">sTHR</span>), <span class="var type0" id="S12T0U155">sTHR</span> = -Inf; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,71" id="srcline71"> 71</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,72" id="srcline72"> 72</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S7T8U164">plim</span>), <span class="var type0" id="S7T0U167">plim</span> = [30 5000]; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,73" id="srcline73"> 73</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S8T1U177">dt</span>) || isnan(<span class="var type1" id="S8T1U180">dt</span>), <span class="var type0" id="S8T0U183">dt</span> = 0.001; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,74" id="srcline74"> 74</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S9T1U190">dlog2p</span>) || isnan(<span class="var type1" id="S9T1U193">dlog2p</span>), <span class="mxinfo " id="T1:U23"><span class="var type1" id="S9T1U196">dlog2p</span> = <span class="mxinfo " id="T1:U25"><span class="mxinfo " id="T1:U26">1</span>/<span class="mxinfo " id="T1:U27">48</span></span></span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,75" id="srcline75"> 75</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S10T1U205">dERBs</span>) || isnan(<span class="var type1" id="S10T1U208">dERBs</span>), <span class="mxinfo " id="T1:U30"><span class="var type1" id="S10T1U211">dERBs</span> = <span class="mxinfo " id="T1:U32">0.1</span></span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,76" id="srcline76"> 76</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S11T1U218">woverlap</span>) || isnan(<span class="var type1" id="S11T1U221">woverlap</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,77" id="srcline77"> 77</a></span><span class="line">        <span class="mxinfo " id="T1:U35"><span class="var type1" id="S11T1U224">woverlap</span> = <span class="mxinfo " id="T1:U37">0.5</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,78" id="srcline78"> 78</a></span><span class="line">    <span class="keyword">elseif</span> <span class="var type0" id="S11T0U229">woverlap</span>&gt;1 || <span class="var type0" id="S11T0U232">woverlap</span>&lt;0</span></span>
<span class="srcline"><span class="lineno"><a href="160,79" id="srcline79"> 79</a></span><span class="line">        error(<span class="string">'Window overlap must be between 0 and 1.'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,81" id="srcline81"> 81</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S12T1U243">sTHR</span>) || isnan(<span class="var type1" id="S12T1U246">sTHR</span>), <span class="mxinfo " id="T1:U40"><span class="var type1" id="S12T1U249">sTHR</span> = <span class="mxinfo " id="T1:U42">-<span class="mxinfo " id="T1:U43">Inf</span></span></span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,82" id="srcline82"> 82</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo " id="T3:U44"><span class="var type1" id="S3T3U255">t</span> = <span class="mxinfo " id="T3:U46"><span class="mxinfo " id="T24:U47">[ 0: <span class="var type1" id="S8T1U262">dt</span>: <span class="mxinfo " id="T1:U49"><span class="mxinfo " id="T1:U50">length(<span class="var type1" id="S5T3U266">x</span>)</span>/<span class="var type1" id="S6T1U267">fs</span></span> ]</span>'</span></span>; <span class="comment">% Times</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,84" id="srcline84"> 84</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="160,85" id="srcline85"> 85</a></span><span class="line"><span class="keyword">global</span> <span class="var type1" id="S20T24U269">primetable</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,86" id="srcline86"> 86</a></span><span class="line"><span class="keyword">if</span> (<span class="mxinfo " id="T2:U54">isempty(<span class="var type1" id="S20T24U275">primetable</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T24:U56"><span class="var type1" id="S20T24U278">primetable</span> = <span class="mxinfo " id="T151:U58">[<span class="mxinfo " id="T1:U59">1</span> <span class="mxinfo " id="T133:U60">primes(10000)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,88" id="srcline88"> 88</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,89" id="srcline89"> 89</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="160,90" id="srcline90"> 90</a></span><span class="line"><span class="comment">% Define pitch candidates</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,91" id="srcline91"> 91</a></span><span class="line"><span class="mxinfo " id="T121:U61"><span class="var type1" id="S22T121U287">log2pc</span> = <span class="mxinfo " id="T121:U63"><span class="mxinfo " id="T126:U64">[ log2(<span class="var type1" id="S7T8U296">plim</span>(1)): <span class="mxinfo " id="T1:U66"><span class="var type1" id="S9T1U298">dlog2p</span></span>: log2(<span class="var type1" id="S7T8U302">plim</span>(2)) ]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,92" id="srcline92"> 92</a></span><span class="line"><span class="mxinfo " id="T121:U69"><span class="var type1" id="S24T121U306">pc</span> = <span class="mxinfo " id="T3:U71">2 .^ <span class="var type1" id="S22T121U309">log2pc</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,93" id="srcline93"> 93</a></span><span class="line"><span class="mxinfo " id="T122:U73"><span class="var type1" id="S25T122U312">S</span> = <span class="mxinfo " id="T122:U75">zeros( <span class="mxinfo " id="T1:U76">length(<span class="var type1" id="S24T121U317">pc</span>)</span>, <span class="mxinfo " id="T1:U78">length(<span class="var type1" id="S3T3U320">t</span>)</span> )</span></span>; <span class="comment">% Pitch strength matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,94" id="srcline94"> 94</a></span><span class="line"><span class="comment">% Determine P2-WSs</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,95" id="srcline95"> 95</a></span><span class="line"><span class="mxinfo " id="T8:U80"><span class="var type1" id="S27T8U323">logWs</span> = <span class="mxinfo " id="T8:U82">round( <span class="mxinfo " id="T8:U83">log2( <span class="mxinfo " id="T8:U84"><span class="mxinfo " id="T1:U85"><span class="mxinfo " id="T1:U86">8</span>*<span class="var type1" id="S6T1U331">fs</span></span> ./ <span class="mxinfo " id="T8:U88"><span class="var type1" id="S7T8U332">plim</span></span></span> )</span> )</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="160,96" id="srcline96"> 96</a></span><span class="line"><span class="mxinfo " id="T24:U90"><span class="var type1" id="S29T24U335">ws</span> = <span class="mxinfo " id="T24:U92">2.^<span class="mxinfo " id="T24:U93">[ <span class="mxinfo " id="T1:U94"><span class="var type1" id="S27T8U343">logWs</span>(<span class="mxinfo " id="T1:U96">1</span>)</span>: -1: <span class="mxinfo " id="T1:U97"><span class="var type1" id="S27T8U348">logWs</span>(<span class="mxinfo " id="T1:U99">2</span>)</span> ]</span></span></span>; <span class="comment">% P2-WSs</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,97" id="srcline97"> 97</a></span><span class="line"><span class="mxinfo " id="T24:U100"><span class="var type1" id="S30T24U352">pO</span> = <span class="mxinfo " id="T24:U102"><span class="mxinfo " id="T1:U103"><span class="mxinfo " id="T1:U104">8</span> * <span class="var type1" id="S6T1U356">fs</span></span> ./ <span class="var type1" id="S29T24U357">ws</span></span></span>; <span class="comment">% Optimal pitches for P2-WSs</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">% Determine window sizes used by each pitch candidate</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo " id="T121:U107"><span class="var type1" id="S31T121U360">d</span> = <span class="mxinfo " id="T121:U109"><span class="mxinfo " id="T121:U110"><span class="mxinfo " id="T1:U111">1</span> + <span class="var type1" id="S22T121U364">log2pc</span></span> - <span class="mxinfo " id="T1:U113">log2( <span class="mxinfo " id="T1:U114"><span class="mxinfo " id="T1:U115"><span class="mxinfo " id="T1:U116">8</span>*<span class="var type1" id="S6T1U370">fs</span></span>./<span class="mxinfo " id="T1:U118"><span class="var type1" id="S29T24U372">ws</span>(<span class="mxinfo " id="T1:U120">1</span>)</span></span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,100" id="srcline100">100</a></span><span class="line"><span class="comment">% Create ERB-scale uniformly-spaced frequencies (in Hertz)</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,101" id="srcline101">101</a></span><span class="line"><span class="mxinfo " id="T3:U121"><span class="var type1" id="S32T3U376">fERBs</span> = <span class="mxinfo " id="T3:U123"><span class="fcn" id="F710N17:B378">erbs2hz</span>(<span class="mxinfo " id="T3:U124"><span class="mxinfo " id="T24:U125">[ <span class="mxinfo " id="T1:U126"><span class="fcn" id="F709N18:B385">hz2erbs</span>(<span class="mxinfo " id="T1:U127"><span class="mxinfo " id="T1:U128">min(<span class="var type1" id="S24T121U389">pc</span>)</span>/<span class="mxinfo " id="T1:U130">4</span></span>)</span>: <span class="mxinfo " id="T1:U131"><span class="var type1" id="S10T1U391">dERBs</span></span>: <span class="mxinfo " id="T1:U133"><span class="fcn" id="F709N18:B393">hz2erbs</span>(<span class="mxinfo " id="T1:U134"><span class="var type1" id="S6T1U395">fs</span>/<span class="mxinfo " id="T1:U136">2</span></span>)</span> ]</span>'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,102" id="srcline102">102</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S36T1U399">i</span> = <span class="mxinfo " id="T1:U138">1</span> : <span class="mxinfo " id="T1:U139">length(<span class="var type1" id="S29T24U404">ws</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,103" id="srcline103">103</a></span><span class="line">    <span class="mxinfo " id="T1:U141"><span class="var type1" id="S37T1U407">dn</span> = <span class="mxinfo " id="T1:U143">max( <span class="mxinfo " id="T1:U144">1</span>, <span class="mxinfo " id="T1:U145">round( <span class="mxinfo " id="T1:U146"><span class="mxinfo " id="T1:U147"><span class="mxinfo " id="T1:U148"><span class="mxinfo " id="T1:U149">8</span>*(<span class="mxinfo " id="T1:U150"><span class="mxinfo " id="T1:U151">1</span>-<span class="var type1" id="S11T1U420">woverlap</span></span>)</span> * <span class="var type1" id="S6T1U421">fs</span></span> / <span class="mxinfo " id="T1:U154"><span class="var type1" id="S30T24U423">pO</span>(<span class="var type1" id="S36T1U424">i</span>)</span></span> )</span> )</span></span>; <span class="comment">% Hop size</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,104" id="srcline104">104</a></span><span class="line">    <span class="comment">% Zero pad signal</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo " id="T3:U157"><span class="var type1" id="S39T3U427">xzp</span> = <span class="mxinfo " id="T3:U159">[ <span class="mxinfo " id="T3:U160">zeros( <span class="mxinfo " id="T1:U161"><span class="mxinfo " id="T1:U162"><span class="var type1" id="S29T24U434">ws</span>(<span class="var type1" id="S36T1U435">i</span>)</span>/<span class="mxinfo " id="T1:U165">2</span></span>, 1 )</span>; <span class="mxinfo " id="T3:U166"><span class="var type1" id="S5T3U440">x</span>(:)</span>; <span class="mxinfo " id="T3:U168">zeros( <span class="mxinfo " id="T1:U169"><span class="var type1" id="S37T1U446">dn</span> + <span class="mxinfo " id="T1:U171"><span class="mxinfo " id="T1:U172"><span class="var type1" id="S29T24U449">ws</span>(<span class="var type1" id="S36T1U450">i</span>)</span>/<span class="mxinfo " id="T1:U175">2</span></span></span>, 1 )</span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,106" id="srcline106">106</a></span><span class="line">    <span class="comment">% Compute spectrum</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,107" id="srcline107">107</a></span><span class="line">    <span class="keyword">if</span> coder.target(<span class="string">'MATLAB'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,108" id="srcline108">108</a></span><span class="line">        <span class="var type0" id="S40T0U462">w</span> = hanning( <span class="var type0" id="S29T0U466">ws</span>(<span class="var type0" id="S36T0U467">i</span>) ); <span class="comment">% Hann window </span></span></span>
<span class="srcline"><span class="lineno"><a href="160,109" id="srcline109">109</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,110" id="srcline110">110</a></span><span class="line">        <span class="mxinfo " id="T3:U176"><span class="var type1" id="S40T3U471">w</span> = <span class="mxinfo " id="T3:U178">zeros(<span class="mxinfo " id="T1:U179"><span class="var type1" id="S29T24U475">ws</span>(<span class="var type1" id="S36T1U476">i</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,111" id="srcline111">111</a></span><span class="line">        coder.ceval(<span class="string">'hanning'</span>,coder.ref(<span class="mxinfo " id="T3:U182"><span class="var type1" id="S40T3U488">w</span></span>),<span class="mxinfo " id="T1:U184"><span class="var type1" id="S29T24U490">ws</span>(<span class="var type1" id="S36T1U491">i</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="160,112" id="srcline112">112</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,113" id="srcline113">113</a></span><span class="line">    <span class="mxinfo " id="T1:U187"><span class="var type1" id="S42T1U494">o</span> = <span class="mxinfo " id="T1:U189">max( <span class="mxinfo " id="T1:U190">0</span>, <span class="mxinfo " id="T1:U191">round( <span class="mxinfo " id="T1:U192"><span class="mxinfo " id="T1:U193"><span class="var type1" id="S29T24U502">ws</span>(<span class="var type1" id="S36T1U503">i</span>)</span> - <span class="var type1" id="S37T1U504">dn</span></span> )</span> )</span></span>; <span class="comment">% Window overlap</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,114" id="srcline114">114</a></span><span class="line">    <span class="keyword">if</span> coder.target(<span class="string">'MATLAB'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="160,115" id="srcline115">115</a></span><span class="line">        [ <span class="var type0" id="S43T0U515">X</span>, <span class="var type0" id="S44T0U516">f</span>, <span class="var type0" id="S45T0U517">ti</span> ] = specgram( <span class="var type0" id="S39T0U520">xzp</span>, <span class="var type0" id="S29T0U522">ws</span>(<span class="var type0" id="S36T0U523">i</span>), <span class="var type0" id="S6T0U524">fs</span>, <span class="var type0" id="S40T0U525">w</span>, <span class="var type0" id="S42T0U526">o</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="160,116" id="srcline116">116</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,117" id="srcline117">117</a></span><span class="line">        <span class="mxinfo " id="T1:U197"><span class="var type1" id="S47T1U530">windowSize</span> = <span class="mxinfo " id="T1:U199"><span class="var type1" id="S29T24U532">ws</span>(<span class="var type1" id="S36T1U533">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,118" id="srcline118">118</a></span><span class="line">        <span class="mxinfo " id="T1:U202"><span class="var type1" id="S48T1U536">framestep</span> = <span class="mxinfo " id="T1:U204"><span class="var type1" id="S47T1U538">windowSize</span> - <span class="var type1" id="S42T1U539">o</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,119" id="srcline119">119</a></span><span class="line">        <span class="mxinfo " id="T1:U207"><span class="var type1" id="S49T1U542">bins</span> = <span class="mxinfo " id="T1:U209"><span class="mxinfo " id="T1:U210"><span class="var type1" id="S47T1U545">windowSize</span> / <span class="mxinfo " id="T1:U212">2</span></span> + <span class="mxinfo " id="T1:U213">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,120" id="srcline120">120</a></span><span class="line">        <span class="mxinfo " id="T1:U214"><span class="var type1" id="S50T1U550">frames</span> = <span class="mxinfo " id="T1:U216">(<span class="mxinfo " id="T1:U217"><span class="mxinfo " id="T1:U218">length(<span class="var type1" id="S39T3U556">xzp</span>)</span> - <span class="var type1" id="S42T1U557">o</span></span>) / <span class="var type1" id="S48T1U558">framestep</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="160,121" id="srcline121">121</a></span><span class="line">        <span class="mxinfo " id="T62:U222"><span class="var type1" id="S43T62U561">X</span> = <span class="mxinfo " id="T62:U224">complex(<span class="mxinfo " id="T27:U225">zeros(<span class="var type1" id="S49T1U566">bins</span>,<span class="var type1" id="S50T1U567">frames</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,122" id="srcline122">122</a></span><span class="line">        <span class="mxinfo " id="T3:U228"><span class="var type1" id="S44T3U570">f</span> = <span class="mxinfo " id="T3:U230">zeros(<span class="var type1" id="S49T1U573">bins</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,123" id="srcline123">123</a></span><span class="line">        <span class="mxinfo " id="T3:U232"><span class="var type1" id="S45T3U577">ti</span> = <span class="mxinfo " id="T3:U234">zeros(<span class="var type1" id="S50T1U580">frames</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,124" id="srcline124">124</a></span><span class="line">        <span class="comment">% use argument order of newer spectrogram function, for which we</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,125" id="srcline125">125</a></span><span class="line">        <span class="comment">% have documentation</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,126" id="srcline126">126</a></span><span class="line">        coder.ceval(<span class="string">'spectrogram'</span>,coder.ref(<span class="mxinfo " id="T62:U236"><span class="var type1" id="S43T62U592">X</span></span>), coder.ref(<span class="mxinfo " id="T3:U238"><span class="var type1" id="S44T3U597">f</span></span>), coder.ref(<span class="mxinfo " id="T3:U240"><span class="var type1" id="S45T3U602">ti</span></span>), <span class="var type1" id="S39T3U603">xzp</span>, <span class="mxinfo " id="T1:U243">length(<span class="var type1" id="S39T3U606">xzp</span>)</span>, <span class="var type1" id="S40T3U607">w</span>, <span class="var type1" id="S42T1U608">o</span>, <span class="var type1" id="S47T1U609">windowSize</span>, <span class="var type1" id="S6T1U610">fs</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="160,127" id="srcline127">127</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,128" id="srcline128">128</a></span><span class="line">    <span class="comment">% Select candidates that use this window size</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,129" id="srcline129">129</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U249"><span class="mxinfo " id="T1:U250">length(<span class="var type1" id="S29T24U616">ws</span>)</span> == <span class="mxinfo " id="T1:U252">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,130" id="srcline130">130</a></span><span class="line">        <span class="mxinfo " id="T125:U253"><span class="var type1" id="S52T125U620">j</span>=<span class="mxinfo " id="T126:U255"><span class="mxinfo " id="T121:U256">[(<span class="var type1" id="S24T121U625">pc</span>)]</span>'</span></span>; <span class="mxinfo " id="T125:U258"><span class="var type1" id="S53T125U628">k</span> = <span class="mxinfo " id="T21:U260">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,131" id="srcline131">131</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T2:U261"><span class="var type1" id="S36T1U633">i</span> == <span class="mxinfo " id="T1:U263">length(<span class="var type1" id="S29T24U636">ws</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,132" id="srcline132">132</a></span><span class="line">        <span class="mxinfo " id="T125:U265"><span class="var type1" id="S52T125U639">j</span>=<span class="mxinfo " id="T3:U267">find(<span class="mxinfo " id="T152:U268"><span class="mxinfo " id="T121:U269"><span class="var type1" id="S31T121U644">d</span>-<span class="var type1" id="S36T1U645">i</span></span>&gt;<span class="mxinfo " id="T1:U272">-<span class="mxinfo " id="T1:U273">1</span></span></span>)</span></span>; <span class="mxinfo " id="T125:U274"><span class="var type1" id="S53T125U650">k</span>=<span class="mxinfo " id="T3:U276">find(<span class="mxinfo " id="T153:U277"><span class="mxinfo " id="T154:U278"><span class="mxinfo " id="T154:U279"><span class="var type1" id="S31T121U656">d</span>(<span class="var type1" id="S52T125U657">j</span>)</span>-<span class="var type1" id="S36T1U658">i</span></span>&lt;<span class="mxinfo " id="T1:U283">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,133" id="srcline133">133</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T2:U284"><span class="var type1" id="S36T1U662">i</span>==<span class="mxinfo " id="T1:U286">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,134" id="srcline134">134</a></span><span class="line">        <span class="mxinfo " id="T125:U287"><span class="var type1" id="S52T125U666">j</span>=<span class="mxinfo " id="T3:U289">find(<span class="mxinfo " id="T152:U290"><span class="mxinfo " id="T121:U291"><span class="var type1" id="S31T121U671">d</span>-<span class="mxinfo " id="T1:U293"><span class="var type1" id="S36T1U672">i</span></span></span>&lt;<span class="mxinfo " id="T1:U295">1</span></span>)</span></span>; <span class="mxinfo " id="T125:U296"><span class="var type1" id="S53T125U676">k</span>=<span class="mxinfo " id="T3:U298">find(<span class="mxinfo " id="T153:U299"><span class="mxinfo " id="T154:U300"><span class="mxinfo " id="T154:U301"><span class="var type1" id="S31T121U682">d</span>(<span class="var type1" id="S52T125U683">j</span>)</span>-<span class="mxinfo " id="T1:U304"><span class="var type1" id="S36T1U684">i</span></span></span>&gt;<span class="mxinfo " id="T1:U306">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,135" id="srcline135">135</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,136" id="srcline136">136</a></span><span class="line">        <span class="mxinfo " id="T125:U307"><span class="var type1" id="S52T125U689">j</span>=<span class="mxinfo " id="T3:U309">find(<span class="mxinfo " id="T152:U310"><span class="mxinfo " id="T3:U311">abs(<span class="mxinfo " id="T121:U312"><span class="var type1" id="S31T121U696">d</span>-<span class="var type1" id="S36T1U697">i</span></span>)</span>&lt;<span class="mxinfo " id="T1:U315">1</span></span>)</span></span>; <span class="mxinfo " id="T125:U316"><span class="var type1" id="S53T125U701">k</span>=<span class="mxinfo " id="T24:U318">1:<span class="mxinfo " id="T1:U319">length(<span class="var type1" id="S52T125U706">j</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,137" id="srcline137">137</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,138" id="srcline138">138</a></span><span class="line">    <span class="comment">% Compute loudness at ERBs uniformly-spaced frequencies</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,139" id="srcline139">139</a></span><span class="line">    <span class="mxinfo " id="T115:U321"><span class="var type1" id="S56T115U709">found</span> = <span class="mxinfo " id="T115:U323">find( <span class="mxinfo " id="T42:U324"><span class="var type1" id="S32T3U713">fERBs</span> &gt; <span class="mxinfo " id="T1:U326"><span class="mxinfo " id="T1:U327"><span class="var type1" id="S24T121U716">pc</span>(<span class="mxinfo " id="T1:U329"><span class="var type1" id="S52T125U718">j</span>(<span class="mxinfo " id="T1:U331">1</span>)</span>)</span>/<span class="mxinfo " id="T1:U332">4</span></span></span>, 1, <span class="string">'first'</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo " id="T3:U333"><span class="var type1" id="S32T3U725">fERBs</span> = <span class="mxinfo " id="T3:U335"><span class="var type1" id="S32T3U727">fERBs</span>( <span class="mxinfo " id="T1:U337"><span class="var type1" id="S56T115U730">found</span>(<span class="mxinfo " id="T1:U339">1</span>)</span> : <span class="mxinfo " id="T1:U340">end</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo " id="T27:U341"><span class="var type1" id="S58T27U736">L</span> = <span class="mxinfo " id="T27:U343">sqrt( <span class="mxinfo " id="T27:U344">max( 0, <span class="mxinfo " id="T27:U345">interp1( <span class="var type1" id="S44T3U744">f</span>, <span class="mxinfo " id="T27:U347">abs(<span class="var type1" id="S43T62U747">X</span>)</span>, <span class="var type1" id="S32T3U748">fERBs</span>, <span class="string">'spline'</span>, 0)</span> )</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,142" id="srcline142">142</a></span><span class="line">    <span class="comment">% Compute pitch strength</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,143" id="srcline143">143</a></span><span class="line">    <span class="mxinfo " id="T122:U350"><span class="var type1" id="S61T122U753">Si</span> = <span class="mxinfo " id="T27:U352"><span class="fcn" id="F988N19:B755">pitchStrengthAllCandidates</span>( <span class="var type1" id="S32T3U756">fERBs</span>, <span class="var type1" id="S58T27U757">L</span>, <span class="mxinfo " id="T125:U355"><span class="var type1" id="S24T121U759">pc</span>(<span class="var type1" id="S52T125U760">j</span>)</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,144" id="srcline144">144</a></span><span class="line">    <span class="comment">% Interpolate pitch strength at desired times</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,145" id="srcline145">145</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U358"><span class="mxinfo " id="T1:U359">size(<span class="var type1" id="S61T122U766">Si</span>,2)</span> &gt; <span class="mxinfo " id="T1:U361">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,146" id="srcline146">146</a></span><span class="line">        <span class="mxinfo " id="T92:U362"><span class="extrinsicFcn" id="F1481N22:B770">warning</span> <span class="mxinfo " id="T6:U363"><span class="string">off</span></span> <span class="mxinfo " id="T147:U364"><span class="string">MATLAB:interp1:NaNinY</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,147" id="srcline147">147</a></span><span class="line">        <span class="mxinfo " id="T122:U365"><span class="var type1" id="S61T122U775">Si</span> = <span class="mxinfo " id="T27:U367"><span class="mxinfo " id="T27:U368">interp1( <span class="var type1" id="S45T3U779">ti</span>, <span class="mxinfo " id="T155:U370"><span class="var type1" id="S61T122U781">Si</span>'</span>, <span class="var type1" id="S3T3U782">t</span>, <span class="string">'linear'</span>, NaN )</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,148" id="srcline148">148</a></span><span class="line">        <span class="mxinfo " id="T92:U373"><span class="extrinsicFcn" id="F1482N22:B787">warning</span> <span class="mxinfo " id="T31:U374"><span class="string">on</span></span> <span class="mxinfo " id="T147:U375"><span class="string">MATLAB:interp1:NaNinY</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,149" id="srcline149">149</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,150" id="srcline150">150</a></span><span class="line">        <span class="mxinfo " id="T122:U376"><span class="var type1" id="S61T122U793">Si</span> = <span class="mxinfo " id="T27:U378">repmat( NaN, <span class="mxinfo " id="T1:U379">length(<span class="var type1" id="S61T122U800">Si</span>)</span>, <span class="mxinfo " id="T1:U381">length(<span class="var type1" id="S3T3U803">t</span>)</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,151" id="srcline151">151</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,152" id="srcline152">152</a></span><span class="line">    <span class="comment">% Add pitch strength to combination</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,153" id="srcline153">153</a></span><span class="line">    <span class="mxinfo " id="T125:U383"><span class="var type1" id="S67T125U806">lambda</span> = <span class="mxinfo " id="T125:U385"><span class="mxinfo " id="T125:U386"><span class="var type1" id="S31T121U809">d</span>( <span class="mxinfo " id="T125:U388"><span class="var type1" id="S52T125U811">j</span>(<span class="var type1" id="S53T125U812">k</span>)</span> )</span> - <span class="var type1" id="S36T1U813">i</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T125:U392"><span class="var type1" id="S68T125U816">mu</span> = <span class="mxinfo " id="T125:U394">ones( <span class="mxinfo " id="T8:U395">size(<span class="var type1" id="S52T125U821">j</span>)</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo " id="T125:U397"><span class="mxinfo " id="T125:U398"><span class="var type1" id="S68T125U825">mu</span>(<span class="var type1" id="S53T125U826">k</span>)</span> = <span class="mxinfo " id="T125:U401"><span class="mxinfo " id="T1:U402">1</span> - <span class="mxinfo " id="T27:U403">abs( <span class="var type1" id="S67T125U831">lambda</span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,156" id="srcline156">156</a></span><span class="line">    <span class="mxinfo " id="T156:U405"><span class="mxinfo " id="T156:U406"><span class="var type1" id="S25T122U835">S</span>(<span class="var type1" id="S52T125U836">j</span>,:)</span> = <span class="mxinfo " id="T122:U409"><span class="mxinfo " id="T156:U410"><span class="var type1" id="S25T122U840">S</span>(<span class="var type1" id="S52T125U841">j</span>,:)</span> + <span class="mxinfo " id="T122:U413"><span class="mxinfo " id="T27:U414">repmat(<span class="var type1" id="S68T125U846">mu</span>,1,<span class="mxinfo " id="T1:U416">size(<span class="var type1" id="S61T122U850">Si</span>,2)</span>)</span> .* <span class="var type1" id="S61T122U852">Si</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,157" id="srcline157">157</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,158" id="srcline158">158</a></span><span class="line"><span class="comment">% Fine tune pitch using parabolic interpolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,159" id="srcline159">159</a></span><span class="line"><span class="mxinfo " id="T3:U419"><span class="var type1" id="S2T3U855">p</span> = <span class="mxinfo " id="T3:U421">repmat( NaN, <span class="mxinfo " id="T1:U422">size(<span class="var type1" id="S25T122U862">S</span>,2)</span>, 1 )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,160" id="srcline160">160</a></span><span class="line"><span class="mxinfo " id="T3:U424"><span class="var type1" id="S4T3U867">s</span> = <span class="mxinfo " id="T3:U426">repmat( NaN, <span class="mxinfo " id="T1:U427">size(<span class="var type1" id="S25T122U874">S</span>,2)</span>, 1 )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,161" id="srcline161">161</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S52T1U879">j</span> = <span class="mxinfo " id="T1:U430">1</span> : <span class="mxinfo " id="T1:U431">size(<span class="var type1" id="S25T122U884">S</span>,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,162" id="srcline162">162</a></span><span class="line">    [ <span class="mxinfo " id="T1:U433"><span class="var type1" id="S4T3U890">s</span>(<span class="var type1" id="S52T1U891">j</span>)</span>, <span class="mxinfo " id="T1:U436"><span class="var type1" id="S36T1U892">i</span></span> ] = max( <span class="mxinfo " id="T121:U438"><span class="var type1" id="S25T122U896">S</span>(:,<span class="var type1" id="S52T1U898">j</span>)</span>, [], 1 );</span></span>
<span class="srcline"><span class="lineno"><a href="160,163" id="srcline163">163</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U441"><span class="mxinfo " id="T1:U442"><span class="var type1" id="S4T3U906">s</span>(<span class="var type1" id="S52T1U907">j</span>)</span> &lt; <span class="var type1" id="S12T1U908">sTHR</span></span>, <span class="keyword">continue</span>, <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,164" id="srcline164">164</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U446"><span class="var type1" id="S36T1U914">i</span> == <span class="mxinfo " id="T1:U448">1</span></span> || <span class="mxinfo " id="T2:U449"><span class="var type1" id="S36T1U917">i</span> == <span class="mxinfo " id="T1:U451">length(<span class="var type1" id="S24T121U920">pc</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,165" id="srcline165">165</a></span><span class="line">        <span class="mxinfo " id="T1:U453"><span class="mxinfo " id="T1:U454"><span class="var type1" id="S2T3U924">p</span>(<span class="var type1" id="S52T1U925">j</span>)</span> = <span class="mxinfo " id="T1:U457"><span class="var type1" id="S24T121U927">pc</span>(<span class="var type1" id="S36T1U928">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,166" id="srcline166">166</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,167" id="srcline167">167</a></span><span class="line">        <span class="mxinfo " id="T123:U460"><span class="var type1" id="S70T123U932">I</span> = <span class="mxinfo " id="T123:U462"><span class="mxinfo " id="T1:U463"><span class="var type1" id="S36T1U935">i</span>-<span class="mxinfo " id="T1:U465">1</span></span> : <span class="mxinfo " id="T1:U466"><span class="var type1" id="S36T1U938">i</span>+<span class="mxinfo " id="T1:U468">1</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,168" id="srcline168">168</a></span><span class="line">        <span class="mxinfo " id="T124:U469"><span class="var type1" id="S71T124U942">tc</span> = <span class="mxinfo " id="T3:U471"><span class="mxinfo " id="T1:U472">1</span> ./ <span class="mxinfo " id="T124:U473"><span class="var type1" id="S24T121U946">pc</span>(<span class="var type1" id="S70T123U947">I</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,169" id="srcline169">169</a></span><span class="line">        <span class="mxinfo " id="T124:U476"><span class="var type1" id="S72T124U950">ntc</span> = <span class="mxinfo " id="T3:U478"><span class="mxinfo " id="T3:U479">( <span class="mxinfo " id="T124:U480"><span class="mxinfo " id="T3:U481"><span class="var type1" id="S71T124U956">tc</span>/<span class="mxinfo " id="T1:U483"><span class="var type1" id="S71T124U958">tc</span>(<span class="mxinfo " id="T1:U485">2</span>)</span></span> - <span class="mxinfo " id="T1:U486">1</span></span> ) * <span class="mxinfo " id="T1:U487">2</span></span>*<span class="mxinfo " id="T1:U488">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,170" id="srcline170">170</a></span><span class="line">        <span class="mxinfo " id="T49:U489"><span class="var type1" id="S74T49U966">c</span> = <span class="mxinfo " id="T49:U491">polyfit( <span class="var type1" id="S72T124U969">ntc</span>, <span class="mxinfo " id="T124:U493"><span class="var type1" id="S25T122U971">S</span>(<span class="var type1" id="S70T123U972">I</span>,<span class="var type1" id="S52T1U973">j</span>)</span>, 2 )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,171" id="srcline171">171</a></span><span class="line">        <span class="mxinfo " id="T24:U497"><span class="var type1" id="S76T24U977">ftc</span> = <span class="mxinfo " id="T24:U499"><span class="mxinfo " id="T1:U500">1</span> ./ <span class="mxinfo " id="T24:U501">2.^<span class="mxinfo " id="T24:U502">[ <span class="mxinfo " id="T1:U503">log2(<span class="mxinfo " id="T1:U504"><span class="var type1" id="S24T121U989">pc</span>(<span class="mxinfo " id="T1:U506"><span class="var type1" id="S70T123U991">I</span>(<span class="mxinfo " id="T1:U508">1</span>)</span>)</span>)</span>: 1/12/100: <span class="mxinfo " id="T1:U509">log2(<span class="mxinfo " id="T1:U510"><span class="var type1" id="S24T121U1001">pc</span>(<span class="mxinfo " id="T1:U512"><span class="var type1" id="S70T123U1003">I</span>(<span class="mxinfo " id="T1:U514">3</span>)</span>)</span>)</span> ]</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,172" id="srcline172">172</a></span><span class="line">        <span class="mxinfo " id="T24:U515"><span class="var type1" id="S77T24U1007">nftc</span> = <span class="mxinfo " id="T24:U517"><span class="mxinfo " id="T24:U518">( <span class="mxinfo " id="T24:U519"><span class="mxinfo " id="T24:U520"><span class="var type1" id="S76T24U1013">ftc</span>/<span class="mxinfo " id="T1:U522"><span class="var type1" id="S71T124U1015">tc</span>(<span class="mxinfo " id="T1:U524">2</span>)</span></span> - <span class="mxinfo " id="T1:U525">1</span></span> ) * <span class="mxinfo " id="T1:U526">2</span></span>*<span class="mxinfo " id="T1:U527">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,173" id="srcline173">173</a></span><span class="line">        [<span class="mxinfo " id="T1:U528"><span class="var type1" id="S4T3U1025">s</span>(<span class="var type1" id="S52T1U1026">j</span>)</span> <span class="mxinfo " id="T1:U531"><span class="var type1" id="S53T1U1027">k</span></span>] = max( <span class="mxinfo " id="T24:U533">polyval( <span class="var type1" id="S74T49U1032">c</span>, <span class="var type1" id="S77T24U1033">nftc</span> )</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="160,174" id="srcline174">174</a></span><span class="line">        <span class="mxinfo " id="T1:U536"><span class="mxinfo " id="T1:U537"><span class="var type1" id="S2T3U1037">p</span>(<span class="var type1" id="S52T1U1038">j</span>)</span> = <span class="mxinfo " id="T1:U540"><span class="mxinfo " id="T1:U541">2</span> ^ ( <span class="mxinfo " id="T1:U542"><span class="mxinfo " id="T1:U543">log2(<span class="mxinfo " id="T1:U544"><span class="var type1" id="S24T121U1046">pc</span>(<span class="mxinfo " id="T1:U546"><span class="var type1" id="S70T123U1048">I</span>(<span class="mxinfo " id="T1:U548">1</span>)</span>)</span>)</span> + <span class="mxinfo " id="T1:U549"><span class="mxinfo " id="T1:U550">(<span class="mxinfo " id="T1:U551"><span class="var type1" id="S53T1U1054">k</span>-<span class="mxinfo " id="T1:U553">1</span></span>)/<span class="mxinfo " id="T1:U554">12</span></span>/<span class="mxinfo " id="T1:U555">100</span></span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,175" id="srcline175">175</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,176" id="srcline176">176</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,177" id="srcline177">177</a></span><span class="line"></span></span>
</pre>
